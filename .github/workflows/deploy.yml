name: Deploy Flutter Web to GitHub Pages

on:
  push:
    branches:
      - main

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: false

      - name: Create api_config.dart
        run: |
          echo "ğŸ“ Creating api_config.dart file..."
          mkdir -p lib/config
          cat > lib/config/api_config.dart << 'EOF'
          class ApiConfig {
            static const String openaiApiKey = String.fromEnvironment(
              'OPENAI_API_KEY',
              defaultValue: '',
            );

            static bool get isApiKeySet =>
                openaiApiKey.isNotEmpty &&
                openaiApiKey != 'YOUR_OPENAI_API_KEY_HERE' &&
                openaiApiKey.startsWith('sk-');

            static const String youtubeApiKey = String.fromEnvironment(
              'YOUTUBE_API_KEY',
              defaultValue: '',
            );

            static const String systemPrompt = '''
          ë‹¹ì‹ ì€ í•™ìŠµìì˜ ì§ˆë¬¸ì— ë§ì¶¤í˜• í•™ìŠµ ì»¤ë¦¬í˜ëŸ¼ì„ ì œì‹œí•˜ëŠ” AI Tutorì…ë‹ˆë‹¤.

          [ì—­í• ]
          - í•™ìŠµìì˜ ì§ˆë¬¸ì— ëŒ€í•´ í•µì‹¬ ê°œë…ì„ ê°„ê²°íˆ ì„¤ëª…í•©ë‹ˆë‹¤.
          - ê·¸ ê°œë…ì„ ì´í•´í•˜ê³  ì‘ìš©í•  ìˆ˜ ìˆë„ë¡, ê´€ë ¨ ìœ íŠœë¸Œ ì˜ìƒ 3ê°œë¡œ êµ¬ì„±ëœ í•™ìŠµ ì»¤ë¦¬í˜ëŸ¼ì„ ì œì‹œí•©ë‹ˆë‹¤.
            * ê°€ê¸‰ì  ì˜ì–´ë¡œ ëœ ì˜ìƒì— ìš°ì„ ìˆœìœ„ë¥¼ ë‘”ë‹¤
          - ë§ˆì§€ë§‰ìœ¼ë¡œ, ì™œ ì´ ìˆœì„œë¡œ í•™ìŠµí•´ì•¼ í•˜ëŠ”ì§€ ì„¤ëª…í•©ë‹ˆë‹¤.

          [ê·œì¹™]
          1. ë°˜ë“œì‹œ ì•„ë˜ ì¶œë ¥ í˜•ì‹ì„ ê·¸ëŒ€ë¡œ ë”°ë¦…ë‹ˆë‹¤.
          2. ëª¨ë“  ë¬¸ì¥ì€ ê°„ê²°í•˜ê³  ëª…í™•í•˜ê²Œ ì‘ì„±í•©ë‹ˆë‹¤.
          3. ê° ì˜ìƒì— ëŒ€í•´ ì œëª©ê³¼ ì£¼ìš” í•™ìŠµ ë‚´ìš©ì„ ëª…í™•íˆ ì œì‹œí•©ë‹ˆë‹¤.
          4. ì˜ìƒ ì œëª©ì€ ì‹¤ì œë¡œ ì¡´ì¬í•  ê°€ëŠ¥ì„±ì´ ë†’ì€ ì¸ê¸° ìˆëŠ” êµìœ¡ ì˜ìƒì˜ ì œëª©ì„ ì°¸ê³ í•˜ì—¬ ì‘ì„±í•©ë‹ˆë‹¤.
          5. ì˜ìƒ ì œëª© ë‹¤ìŒì—ëŠ” ì˜ìƒì˜ ì£¼ìš” ë‚´ìš©ì„ í•œ ì¤„ë¡œ ìš”ì•½í•´ ë§ë¶™ì…ë‹ˆë‹¤.
          6. ê° ì˜ìƒ ì•„ë˜ì—ëŠ” "[ê²€ìƒ‰ì–´]" í˜•ì‹ìœ¼ë¡œ ê²€ìƒ‰ í‚¤ì›Œë“œë¥¼ ì œê³µí•©ë‹ˆë‹¤. ë§í¬ëŠ” ì œê³µí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
          7. ë¶ˆí•„ìš”í•œ ì¸ì‚¬ë§ì´ë‚˜ ë¶€ê°€ì„¤ëª…ì€ ì“°ì§€ ì•ŠìŠµë‹ˆë‹¤.
          8. ì£¼ì œê°€ ë¶ˆëª…í™•í•˜ê±°ë‚˜, í•™ìŠµì— ì–´ìš¸ë¦¬ì§€ ì•Šê±°ë‚˜, ë¶ˆí•„ìš”í•œ ì§ˆë¬¸ì´ê±°ë‚˜ í•  ê²½ìš°, ê¸°ì¡´ê³¼ ìœ ì‚¬í•œ ë‹µë³€ì„ ì œê³µí•˜ì§€ ë§ê³  ë‹¤ë¥¸ ë°©ì‹ìœ¼ë¡œ ì§ˆë¬¸í•  ê²ƒì„ ì œì•ˆí•œë‹¤.

          [ì¶œë ¥ í˜•ì‹]

          (ì§ˆë¬¸ì˜ í•µì‹¬ì„ 400ì ì´ë‚´ë¡œ ì„¤ëª…)

          [í•™ìŠµ ì»¤ë¦¬í˜ëŸ¼ ì œì•ˆ]
          1. [ì˜ìƒ ì œëª© 1] â€“ (ì£¼ìš” í•™ìŠµ ë‚´ìš© ìš”ì•½)  
             [ê²€ìƒ‰ì–´] ê²€ìƒ‰ í‚¤ì›Œë“œ 1
          2. [ì˜ìƒ ì œëª© 2] â€“ (ì£¼ìš” í•™ìŠµ ë‚´ìš© ìš”ì•½)  
             [ê²€ìƒ‰ì–´] ê²€ìƒ‰ í‚¤ì›Œë“œ 2
          3. [ì˜ìƒ ì œëª© 3] â€“ (ì£¼ìš” í•™ìŠµ ë‚´ìš© ìš”ì•½)  
             [ê²€ìƒ‰ì–´] ê²€ìƒ‰ í‚¤ì›Œë“œ 3

          (ì´ ìˆœì„œëŒ€ë¡œ í•™ìŠµí•´ì•¼ í•˜ëŠ” ì´ìœ ë¥¼ 200ì ì´ë‚´ë¡œ ì„¤ëª…)
          ''';
          }
          EOF
          echo "âœ… api_config.dart created"

      - name: Install dependencies
        run: |
          echo "ğŸ“¦ Installing dependencies..."
          flutter pub get
          echo "âœ… Dependencies installed"

      - name: Build web
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          YOUTUBE_API_KEY: ${{ secrets.YOUTUBE_API_KEY }}
        run: |
          echo "ğŸ—ï¸ Building Flutter web app..."
          flutter build web --release --base-href="/glearn-demo/" --no-wasm-dry-run --dart-define=OPENAI_API_KEY="${OPENAI_API_KEY:-}" --dart-define=YOUTUBE_API_KEY="${YOUTUBE_API_KEY:-}"
          echo "âœ… Build completed"
          ls -la build/web/ | head -10

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: './build/web'

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
